version: '3.8'

services:
  # ============================================
  # Control Peso Web Application
  # ============================================
  controlpeso-web:
    container_name: controlpeso-web
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "8080:8080"  # HTTP
    environment:
      # ASP.NET Core Configuration
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080

      # Data Protection keys path (for antiforgery tokens and auth cookies persistence)
      - ASPNETCORE_DataProtection__Path=/root/.aspnet/DataProtection-Keys

      # Database Connection (SQLite file-based)
      - ConnectionStrings__DefaultConnection=Data Source=/app/data/controlpeso.db

      # Logging Configuration (ThisCloud.Framework)
      - ThisCloud__Loggings__IsEnabled=true
      - ThisCloud__Loggings__MinimumLevel=Information
      - ThisCloud__Loggings__Console__Enabled=true
      - ThisCloud__Loggings__File__Enabled=true
      - ThisCloud__Loggings__File__Path=/app/logs/controlpeso-.ndjson
      - ThisCloud__Loggings__File__RollingFileSizeMb=10
      - ThisCloud__Loggings__File__RetainedFileCountLimit=30
      - ThisCloud__Loggings__File__UseCompactJson=true
      - ThisCloud__Loggings__Redaction__Enabled=true
      - ThisCloud__Loggings__Correlation__HeaderName=X-Correlation-Id
      - ThisCloud__Loggings__Correlation__GenerateIfMissing=true

      # AllowedHosts
      - AllowedHosts=*

      # ⚠️ SECRETS: Configure in docker-compose.override.yml (NOT in Git)
      # DO NOT add sensitive values here - this file is tracked by Git
    
    volumes:
      # Persist SQLite database
      - controlpeso-data:/app/data

      # Persist logs
      - controlpeso-logs:/app/logs

      # Persist Data Protection keys (antiforgery tokens, authentication cookies)
      - controlpeso-keys:/root/.aspnet/DataProtection-Keys
    
    networks:
      - controlpeso-network
    
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    
    labels:
      com.controlpeso.service: "web"
      com.controlpeso.version: "1.0.0"

# ============================================
# Networks
# ============================================
networks:
  controlpeso-network:
    driver: bridge
    name: controlpeso-network

# ============================================
# Volumes
# ============================================
volumes:
  # SQLite database persistence
  controlpeso-data:
    driver: local
    name: controlpeso-data

  # Logs persistence
  controlpeso-logs:
    driver: local
    name: controlpeso-logs

  # Data Protection keys persistence (antiforgery, auth cookies)
  controlpeso-keys:
    driver: local
    name: controlpeso-keys
