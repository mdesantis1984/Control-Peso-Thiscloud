@using Microsoft.AspNetCore.Components.Web
@inherits LayoutComponentBase
@namespace ControlPeso.Web.Components.Layout
@rendermode InteractiveServer

@* MudBlazor Providers - según documentación oficial *@
<MudThemeProvider @ref="_themeProvider" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<CascadingValue Value="@ToggleDarkModeAsync">
    <MudLayout>
        <MudAppBar Elevation="1" Dense="false">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                           Color="Color.Inherit" 
                           Edge="Edge.Start" 
                           OnClick="@ToggleDrawer" 
                           aria-label="Toggle navigation menu" />

            <MudText Typo="Typo.h5" Class="ml-3">Control Peso Thiscloud</MudText>

            <MudSpacer />

            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="@ToggleDarkModeAsync"
                           aria-label="Toggle dark mode" />

            <NotificationBell />

        <AuthorizeView>
            <Authorized>
                @if (_currentUser != null && !string.IsNullOrWhiteSpace(_currentUser.AvatarUrl) && !_currentUser.AvatarUrl.Contains("default-user"))
                {
                    <MudMenu AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             aria-label="User menu">
                        <ActivatorContent>
                            <MudAvatar Image="@_currentUser.AvatarUrl" 
                                       Size="Size.Medium" 
                                       Alt="@_currentUser.Name"
                                       Style="cursor: pointer;" />
                        </ActivatorContent>
                        <ChildContent>
                            <MudMenuItem Icon="@Icons.Material.Filled.Person" 
                                         Href="/profile">
                                Perfil
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Logout" 
                                         Href="/api/auth/logout">
                                Cerrar Sesión
                            </MudMenuItem>
                        </ChildContent>
                    </MudMenu>
                }
                else
                {
                    <MudMenu Icon="@Icons.Material.Filled.AccountCircle" 
                             Color="Color.Inherit" 
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight"
                             aria-label="User menu">
                        <MudMenuItem Icon="@Icons.Material.Filled.Person" 
                                     Href="/profile">
                            Perfil
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Logout" 
                                     Href="/api/auth/logout">
                            Cerrar Sesión
                        </MudMenuItem>
                    </MudMenu>
                }
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/login" 
                           Variant="Variant.Outlined" 
                           Color="Color.Inherit">
                    Iniciar Sesión
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" 
               Elevation="2" 
               ClipMode="DrawerClipMode.Always">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>
</CascadingValue>

<div id="blazor-error-ui" data-nosnippet>
    <MudPaper Elevation="8" Class="pa-4">
        <MudText Color="Color.Error" Typo="Typo.h6">Ha ocurrido un error no controlado</MudText>
        <MudButton Href="." Color="Color.Primary" Class="mt-2">Recargar</MudButton>
        <MudButton OnClick="@DismissError" Color="Color.Default" Class="mt-2 ml-2">Cerrar</MudButton>
    </MudPaper>
</div>
