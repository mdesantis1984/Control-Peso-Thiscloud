@using Microsoft.AspNetCore.Components.Web
@using ControlPeso.Application.Services
@using ControlPeso.Web.Themes

@inherits LayoutComponentBase
@namespace ControlPeso.Web.Components.Layout


@* MudBlazor Providers - Tema personalizado ControlPeso (fixed IndexOutOfRangeException - array extendido a 26 elementos) *@
<MudThemeProvider @ref="_themeProvider" Theme="@ControlPesoTheme.DarkTheme" @bind-IsDarkMode="@_isDarkMode" />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<CascadingValue Value="@ToggleDarkModeAsync">
    <MudLayout>
        <MudAppBar Elevation="1" Dense="false">
            <MudIconButton Icon="@Icons.Material.Filled.Menu" 
                           Color="Color.Inherit" 
                           Edge="Edge.Start" 
                           OnClick="@ToggleDrawer" 
                           aria-label="Toggle navigation menu" />

            <MudText Typo="Typo.h5" Class="ml-3">Control Peso Thiscloud</MudText>

            <MudSpacer />

            <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)"
                           Color="Color.Inherit"
                           OnClick="@ToggleDarkModeAsync"
                           aria-label="Toggle dark mode"
                           Class="mr-3" />

            <NotificationBell Class="mr-3" />

        <AuthorizeView>
            <Authorized>
                @{
                    var firstName = MainLayout.GetFirstName(context.User.Identity?.Name);
                    var hasAvatar = _currentUser != null && !string.IsNullOrWhiteSpace(_currentUser.AvatarUrl);
                }

                <MudMenu @bind-Open="_userMenuOpen" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent Context="activator">
                        @if (hasAvatar)
                        {
                            <MudAvatar Size="Size.Medium" Style="cursor: pointer;" @onclick="@(() => _userMenuOpen = !_userMenuOpen)">
                                <MudImage Src="@_currentUser!.AvatarUrl" Alt="@firstName" />
                            </MudAvatar>
                        }
                        else
                        {
                            <MudAvatar Size="Size.Medium" Color="Color.Primary" Style="cursor: pointer;" @onclick="@(() => _userMenuOpen = !_userMenuOpen)">
                                @AvatarHelper.GetInitials(firstName)
                            </MudAvatar>
                        }
                    </ActivatorContent>
                    <ChildContent>
                        <MudText Typo="Typo.body2" Class="px-4 py-2">@firstName</MudText>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Person" Href="/profile">Perfil</MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Logout" Href="/api/auth/logout">Cerrar Sesión</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/login" 
                           Variant="Variant.Outlined" 
                           Color="Color.Inherit">
                    Iniciar Sesión
                </MudButton>
            </NotAuthorized>
        </AuthorizeView>
    </MudAppBar>

    <MudDrawer @bind-Open="@_drawerOpen" 
               Elevation="2" 
               ClipMode="DrawerClipMode.Always">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4 mb-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>
</CascadingValue>

<div id="blazor-error-ui" data-nosnippet>
    <MudPaper Elevation="8" Class="pa-4">
        <MudText Color="Color.Error" Typo="Typo.h6">Ha ocurrido un error no controlado</MudText>
        <MudButton Href="." Color="Color.Primary" Class="mt-2">Recargar</MudButton>
        <MudButton OnClick="@DismissError" Color="Color.Default" Class="mt-2 ml-2">Cerrar</MudButton>
    </MudPaper>
</div>
