@page "/profile"
@attribute [Authorize]
@using Microsoft.AspNetCore.Authorization
@using ControlPeso.Domain.Enums
@using MudBlazor

<PageTitle>Perfil - Control Peso</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    @if (_isLoading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_user is null)
    {
        <MudAlert Severity="Severity.Error">No se pudo cargar el perfil del usuario.</MudAlert>
    }
    else
    {
        <MudText Typo="Typo.h4" Class="mb-4">Mi Perfil</MudText>

        <MudGrid>
            <!-- Información de cuenta (solo lectura) -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Información de Cuenta</MudText>
                        </CardHeaderContent>
                        <CardHeaderActions>
                            <div class="d-flex flex-column align-center">
                                @if (!string.IsNullOrWhiteSpace(_user.AvatarUrl))
                                {
                                    <MudAvatar Image="@_user.AvatarUrl" Size="Size.Large" Class="mb-2" />
                                }
                                else
                                {
                                    <MudAvatar Color="Color.Primary" Size="Size.Large" Class="mb-2">
                                        @_user.Name[0]
                                    </MudAvatar>
                                }

                                <InputFile id="avatar-file-input" OnChange="OnPhotoSelectedAsync" accept="image/*" hidden />
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           Size="Size.Small"
                                           StartIcon="@Icons.Material.Filled.CameraAlt"
                                           OnClick="TriggerFileInput"
                                           Disabled="@_isSaving">
                                    Cambiar Foto
                                </MudButton>
                            </div>
                        </CardHeaderActions>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudTextField Label="Email"
                                      Value="@_user.Email"
                                      ReadOnly="true"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-3" />

                        <MudTextField Label="ID de Google"
                                      Value="@_user.GoogleId"
                                      ReadOnly="true"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-3" />

                        <MudTextField Label="Miembro desde"
                                      Value="@_user.MemberSince.ToString("dd/MM/yyyy")"
                                      ReadOnly="true"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-3" />

                        <MudChip T="string" Color="@GetRoleColor()" Size="Size.Small">
                            @_user.Role.ToString()
                        </MudChip>
                    </MudCardContent>
                </MudCard>
            </MudItem>

            <!-- Datos editables -->
            <MudItem xs="12" md="6">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Datos Personales</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudTextField Label="Nombre"
                                      Value="@_name"
                                      ValueChanged="@((string v) => _name = v)"
                                      Required="true"
                                      RequiredError="El nombre es obligatorio"
                                      MaxLength="200"
                                      Variant="Variant.Outlined"
                                      Margin="Margin.Dense"
                                      Class="mb-3" />

                        <MudNumericField Label="Altura (cm)"
                                         Value="@_height"
                                         ValueChanged="@((decimal v) => _height = v)"
                                         Required="true"
                                         RequiredError="La altura es obligatoria"
                                         Min="50"
                                         Max="300"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Adornment="Adornment.End"
                                         AdornmentText="cm"
                                         Class="mb-3" />

                        <MudDatePicker Label="Fecha de Nacimiento"
                                       Date="@_dateOfBirth"
                                       DateChanged="@((DateTime? v) => _dateOfBirth = v)"
                                       MaxDate="DateTime.Today"
                                       Editable="true"
                                       Variant="Variant.Outlined"
                                       Margin="Margin.Dense"
                                       Class="mb-3" />

                        <MudNumericField Label="Peso Objetivo"
                                         Value="@_goalWeight"
                                         ValueChanged="@((decimal? v) => _goalWeight = v)"
                                         Min="20"
                                         Max="500"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Adornment="Adornment.End"
                                         AdornmentText="kg"
                                         HelperText="Tu peso deseado"
                                         Class="mb-3" />

                        <MudSelect Label="Sistema de Unidades"
                                   T="UnitSystem"
                                   Value="@_unitSystem"
                                   ValueChanged="@((UnitSystem v) => _unitSystem = v)"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Class="mb-3">
                            <MudSelectItem T="UnitSystem" Value="UnitSystem.Metric">Métrico (kg, cm)</MudSelectItem>
                            <MudSelectItem T="UnitSystem" Value="UnitSystem.Imperial">Imperial (lb, in)</MudSelectItem>
                        </MudSelect>

                        <MudSelect Label="Idioma"
                                   T="string"
                                   Value="@_language"
                                   ValueChanged="@((string v) => _language = v)"
                                   Variant="Variant.Outlined"
                                   Margin="Margin.Dense"
                                   Class="mb-3">
                            <MudSelectItem T="string" Value="@("es")">Español</MudSelectItem>
                            <MudSelectItem T="string" Value="@("en")">English</MudSelectItem>
                        </MudSelect>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="SaveChanges"
                                   Disabled="@_isSaving"
                                   StartIcon="@Icons.Material.Filled.Save">
                            @if (_isSaving)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Cambios</span>
                            }
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>

            <!-- Preferencias -->
            <MudItem xs="12">
                <MudCard Elevation="2">
                    <MudCardHeader>
                        <CardHeaderContent>
                            <MudText Typo="Typo.h6">Preferencias</MudText>
                        </CardHeaderContent>
                    </MudCardHeader>
                    <MudCardContent>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                            <MudText>Modo Oscuro</MudText>
                            <MudSwitch T="bool" Checked="@_darkMode" CheckedChanged="@((bool v) => _darkMode = v)" Color="Color.Primary" />
                        </MudStack>

                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText>Notificaciones</MudText>
                            <MudSwitch T="bool" Checked="@_notificationsEnabled" CheckedChanged="@((bool v) => _notificationsEnabled = v)" Color="Color.Primary" />
                        </MudStack>
                    </MudCardContent>
                    <MudCardActions>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Secondary"
                                   OnClick="SavePreferences"
                                   Disabled="_isSavingPreferences"
                                   StartIcon="@Icons.Material.Filled.Settings">
                            @if (_isSavingPreferences)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Guardando...</span>
                            }
                            else
                            {
                                <span>Guardar Preferencias</span>
                            }
                        </MudButton>
                    </MudCardActions>
                </MudCard>
            </MudItem>
        </MudGrid>
    }
</MudContainer>
