@page "/diagnostics/telegram"
@attribute [Authorize(Roles = "Administrator")]
@using ControlPeso.Web.Services
@using Microsoft.Extensions.Options

<PageTitle>Diagn√≥stico Telegram - Control Peso</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        üîç Diagn√≥stico de Configuraci√≥n Telegram
    </MudText>

    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Estado de Configuraci√≥n</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            @if (_config != null)
            {
                <MudSimpleTable Dense="true" Hover="true">
                    <tbody>
                        <tr>
                            <td><strong>Habilitado:</strong></td>
                            <td>
                                @if (_config.Enabled)
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úÖ S√ç</MudChip>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">‚ùå NO</MudChip>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Bot Token:</strong></td>
                            <td>
                                @if (IsBotTokenConfigured())
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úÖ Configurado</MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        @GetMaskedToken()
                                    </MudText>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">‚ùå NO Configurado</MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                        Valor actual: "@(_config.BotToken ?? "null")"
                                    </MudText>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Chat ID:</strong></td>
                            <td>
                                @if (IsChatIdConfigured())
                                {
                                    <MudChip T="string" Color="Color.Success" Size="Size.Small">‚úÖ Configurado</MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Default">
                                        Chat ID: @_config.ChatId
                                    </MudText>
                                }
                                else
                                {
                                    <MudChip T="string" Color="Color.Error" Size="Size.Small">‚ùå NO Configurado</MudChip>
                                    <MudText Typo="Typo.caption" Color="Color.Error">
                                        Valor actual: "@(_config.ChatId ?? "null")"
                                    </MudText>
                                }
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Ambiente:</strong></td>
                            <td>
                                <MudChip T="string" Color="Color.Info" Size="Size.Small">@_config.Environment</MudChip>
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            }
            else
            {
                <MudAlert Severity="Severity.Error">
                    No se pudo cargar la configuraci√≥n de Telegram
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">Probar Notificaci√≥n</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body2" Class="mb-4">
                Env√≠a un mensaje de prueba para verificar que Telegram est√° configurado correctamente.
            </MudText>

            <MudButton 
                Variant="Variant.Filled" 
                Color="Color.Primary" 
                OnClick="SendTestNotification"
                Disabled="@(!IsFullyConfigured() || _isSending)">
                @if (_isSending)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Enviando...</span>
                }
                else
                {
                    <span>üì§ Enviar Mensaje de Prueba</span>
                }
            </MudButton>

            @if (!string.IsNullOrEmpty(_testResult))
            {
                <MudAlert Severity="@_testResultSeverity" Class="mt-4">
                    @_testResult
                </MudAlert>
            }
        </MudCardContent>
    </MudCard>

    <MudCard Class="mb-4">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">üõ†Ô∏è Gu√≠a de Configuraci√≥n</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                <strong>OPCI√ìN 1: Script Autom√°tico (Recomendado)</strong>
                <MudText Typo="Typo.body2" Class="mt-2">
                    Ejecutar desde la ra√≠z del proyecto:
                </MudText>
                <MudPaper Class="pa-2 mt-2" Elevation="0">
                    <code>.\scripts\configure-telegram.ps1</code>
                </MudPaper>
            </MudAlert>

            <MudAlert Severity="Severity.Warning" Dense="true">
                <strong>OPCI√ìN 2: Manual (5 pasos)</strong>
                <ol style="margin-top: 8px; margin-bottom: 0;">
                    <li>Telegram ‚Üí Buscar: <code>@@BotFather</code></li>
                    <li>Enviar: <code>/newbot</code></li>
                    <li>Copiar BOT TOKEN</li>
                    <li>Buscar tu bot ‚Üí Enviar <code>/start</code></li>
                    <li>Obtener CHAT ID: <br/>
                        <code style="font-size: 0.8rem;">
                            https://api.telegram.org/bot&lt;TOKEN&gt;/getUpdates
                        </code>
                    </li>
                </ol>
            </MudAlert>

            <MudText Typo="Typo.body2" Class="mt-3">
                <strong>Editar:</strong> <code>src/ControlPeso.Web/appsettings.Development.json</code>
            </MudText>
            <MudPaper Class="pa-3 mt-2" Elevation="0">
                <pre style="margin: 0; font-size: 0.85rem;">
"Telegram": {
  "Enabled": true,
  "BotToken": "PEGAR_TU_TOKEN_AQU√ç",
  "ChatId": "PEGAR_TU_CHATID_AQU√ç",
  "Environment": "Development"
}</pre>
            </MudPaper>

            <MudText Typo="Typo.body2" Class="mt-3">
                üìö Documentaci√≥n completa: <code>docs/TELEGRAM_QUICKSTART.md</code>
            </MudText>
        </MudCardContent>
    </MudCard>

    <MudCard>
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">‚ö†Ô∏è Errores Comunes</MudText>
            </CardHeaderContent>
        </MudCardHeader>
        <MudCardContent>
            <MudList T="string" Dense="true">
                <MudListItem T="string">
                    <MudText>
                        <strong>‚ùå "Telegram BotToken is not configured"</strong><br/>
                        <small>‚Üí BotToken sigue siendo "YOUR_TELEGRAM_BOT_TOKEN_HERE"</small>
                    </MudText>
                </MudListItem>
                <MudListItem T="string">
                    <MudText>
                        <strong>‚ùå "Telegram ChatId is not configured"</strong><br/>
                        <small>‚Üí ChatId sigue siendo "YOUR_TELEGRAM_CHAT_ID_HERE"</small>
                    </MudText>
                </MudListItem>
                <MudListItem T="string">
                    <MudText>
                        <strong>‚ùå "Chat not found"</strong><br/>
                        <small>‚Üí No enviaste /start al bot antes de obtener el Chat ID</small>
                    </MudText>
                </MudListItem>
                <MudListItem T="string">
                    <MudText>
                        <strong>‚ùå "Unauthorized"</strong><br/>
                        <small>‚Üí BotToken incorrecto (verifica que copiaste todo)</small>
                    </MudText>
                </MudListItem>
            </MudList>
        </MudCardContent>
    </MudCard>
</MudContainer>
